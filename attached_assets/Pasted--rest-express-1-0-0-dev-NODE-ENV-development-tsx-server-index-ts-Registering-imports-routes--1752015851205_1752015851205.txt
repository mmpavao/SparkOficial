
> rest-express@1.0.0 dev
> NODE_ENV=development tsx server/index.ts

Registering imports routes...
Imports routes registered successfully
10:59:43 PM [express] serving on port 5000
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
[Session Debug] GET /api/auth/user - Session ID: yuNxWxSGv6huXNGw55x8lptpvX0kLfun, User ID: undefined
10:59:54 PM [express] GET /api/auth/user 200 in 127ms :: {"user":null,"authenticated":false}
[Session Debug] GET /api/auth/user - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:00:02 PM [express] GET /api/auth/user 304 in 406ms :: {"user":{"id":22,"companyName":"Spark Comex ‚Ä¶
[Session Debug] GET /api/notifications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
[Session Debug] GET /api/admin/dashboard/metrics - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Authentication successful for user: 22 Role: admin
11:00:02 PM [express] GET /api/notifications/unread-count 200 in 138ms
11:00:02 PM [express] GET /api/notifications 200 in 144ms
Fetching fresh admin metrics
11:00:04 PM [express] GET /api/admin/dashboard/metrics 304 in 1893ms :: {"totalImporters":6,"totalApp‚Ä¶
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:02:55 PM [express] GET /api/notifications/unread-count 200 in 2930ms
[Session Debug] GET /api/admin/credit-applications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
Admin credit applications request - User: 22
Current user role: admin
Fetching fresh credit applications
Found 3 credit applications
11:02:58 PM [express] GET /api/admin/credit-applications 304 in 2568ms :: [{"id":63,"userId":34,"lega‚Ä¶
[Session Debug] GET /api/notifications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:02 PM [express] GET /api/notifications 200 in 125ms
[Session Debug] GET /api/admin/credit-applications/62 - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
üîç PROTE√á√ÉO: admin tentando acessar /api/admin/credit-applications/62
[Session Debug] GET /api/user/financial-settings - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
[Session Debug] GET /api/user/financial-settings - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
üîç Fetching financial settings for user: 22
üë§ User data: {
  id: 22,
  defaultAdminFeeRate: null,
  defaultDownPaymentRate: null,
  defaultPaymentTerms: null
}
üí∞ Final settings being sent: {
  adminFeePercentage: 10,
  downPaymentPercentage: 30,
  paymentTerms: '30,60,90'
}
11:03:04 PM [express] GET /api/user/financial-settings 304 in 733ms :: {"adminFeePercentage":10,"down‚Ä¶
11:03:05 PM [express] GET /api/admin/credit-applications/62 304 in 2083ms :: {"id":62,"userId":33,"le‚Ä¶
[Session Debug] GET /api/credit/applications/62/credit-score - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
11:03:06 PM [express] GET /api/credit/applications/62/credit-score 304 in 1087ms :: {"id":16,"creditA‚Ä¶
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:10 PM [express] GET /api/notifications/unread-count 200 in 125ms
[Session Debug] GET /api/auth/user - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:28 PM [express] GET /api/auth/user 304 in 366ms :: {"user":{"id":22,"companyName":"Spark Comex ‚Ä¶
[Session Debug] GET /api/notifications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
[Session Debug] GET /api/admin/dashboard/metrics - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
11:03:28 PM [express] GET /api/notifications 200 in 126ms
11:03:28 PM [express] GET /api/notifications/unread-count 200 in 128ms
Fetching fresh admin metrics
[Session Debug] GET /api/admin/credit-applications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
Admin credit applications request - User: 22
Current user role: admin
Serving credit applications from cache
11:03:30 PM [express] GET /api/admin/credit-applications 304 in 483ms :: [{"id":63,"userId":34,"legal‚Ä¶
11:03:31 PM [express] GET /api/admin/dashboard/metrics 304 in 2325ms :: {"totalImporters":6,"totalApp‚Ä¶
[Session Debug] GET /api/user/financial-settings - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
[Session Debug] GET /api/user/financial-settings - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
üîç Fetching financial settings for user: 22
[Session Debug] GET /api/admin/credit-applications/63 - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
üë§ User data: {
  id: 22,
  defaultAdminFeeRate: null,
  defaultDownPaymentRate: null,
  defaultPaymentTerms: null
}
üí∞ Final settings being sent: {
  adminFeePercentage: 10,
  downPaymentPercentage: 30,
  paymentTerms: '30,60,90'
}
Authentication successful for user: 22 Role: admin
üîç PROTE√á√ÉO: admin tentando acessar /api/admin/credit-applications/63
11:03:31 PM [express] GET /api/user/financial-settings 304 in 173ms :: {"adminFeePercentage":10,"down‚Ä¶
11:03:32 PM [express] GET /api/admin/credit-applications/63 200 in 868ms :: {"id":63,"userId":34,"leg‚Ä¶
[Session Debug] GET /api/credit/applications/63/credit-score - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
11:03:35 PM [express] GET /api/credit/applications/63/credit-score 404 in 1017ms :: {"message":"Credi‚Ä¶
[Session Debug] POST /api/credit/applications/63/credit-score - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
Auth check - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9 User ID: 22
Authentication successful for user: 22 Role: admin
üìä Calling DirectD APIs for CNPJ: 35364825000170
‚úÖ DirectD Score API response received: {
  "metaDados": {
    "consultaNome": "Score de Cr√©dito - QUOD",
    "consultaUid": "direct-516ef1a4-bb35-496d-b4d2-b36b0298ca8a",
    "chave": "CNPJ=35364825000170;",
    "usuario": "Marcio Pavao",
    "mensagem": "Sucesso",
    "ip": "34.82.198.242",
    "resultadoId": 1,
    "resultado": "Sucesso",
    "apiVersao": "v3",
    "gerarComprovante": false,
    "urlComprovante": null,
    "assincrono": false,
    "data": "08/07/2025 20:03:41",
    "tempoExecucaoMs": 440
  },
  "retorno": {
    "dataConsulta": "07/07/2025 23:04:38",
    "documentoConsultado": "35.364.825/0001-70",
    "pessoaFisica": null,
    "pessoaJuridica": {
      "score": 458,
      "faixaScore": "Alto √≠ndice de inadimpl√™ncia",
      "motivos": [
        "Possui contratos com grande quantidade de parcelas",
        "Possui utiliza√ß√£o de alto valor de cr√©dito do tipo emergencial nos √∫ltimos 3 meses",
        "Possui quadro societ√°rio com baixo n√∫mero de s√≥cios ou acionistas",
        "Possui pouco volume de pagamentos em dia"
      ],
      "indicadoresNegocio": [
        {
          "indicador": "Pontualidade de Pagamento",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Gravidade (tempo) em Atrasos",
          "status": "A empresa n√£o apresenta d√≠vidas vencidas e n√£o pagas.",
          "risco": "Baixo",
          "observacao": null
        },
        {
          "indicador": "Uso Emergencial",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Endividamento Contrato e Credores",
          "status": "A empresa n√£o apresenta contratos em aberto.",
          "risco": "Baixo",
          "observacao": null
        },
        {
          "indicador": "Risco do Perfil de Contrata√ß√£o",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Busca por Cr√©dito Mensal (Quantidade de Novas Contrata√ß√µes)",
          "status": null,
          "risco": null,
          "observacao": null
        }
      ]
    },
    "observacao": null
  }
}
‚úÖ DirectD Cadastro API response received: {
  "metaDados": {
    "consultaNome": "Cadastro - Pessoa Jur√≠dica - Plus",
    "consultaUid": "direct-192fdadc-fdf5-4de1-bfdf-7694e1d82fb4",
    "chave": "CNPJ=35364825000170;",
    "usuario": "Marcio Pavao",
    "mensagem": "Sucesso",
    "ip": "34.82.198.242",
    "resultadoId": 1,
    "resultado": "Sucesso",
    "apiVersao": "v3",
    "gerarComprovante": false,
    "urlComprovante": null,
    "assincrono": false,
    "data": "08/07/2025 20:03:42",
    "tempoExecucaoMs": 435
  },
  "retorno": {
    "cnpj": "35.364.825/0001-70",
    "razaoSocial": "P1LED COMERCIO E IMPORTACAO DE PRODUTOS ELETRICOS E SERVICOS LTDA",
    "nomeFantasia": "P1LED COMERCIO E IMPORTACAO",
    "dataFundacao": "31/10/2019 00:00:00",
    "cnaeCodigo": 4673700,
    "cnaeDescricao": "Com√©rcio Atacadista de Material El√©trico",
    "cnaEsSecundarios": [
      {
        "cnaeCodigoSecundario": 4321500,
        "cnaeDescricaoSecundario": "Instala√ß√£o E Manuten√ß√£o El√©trica"
      },
      {
        "cnaeCodigoSecundario": 4649402,
        "cnaeDescricaoSecundario": "Com√©rcio Atacadista de Aparelhos Eletr√¥nicos de Uso Pessoal E Dom√©stico"
      },
      {
        "cnaeCodigoSecundario": 4651601,
        "cnaeDescricaoSecundario": "Com√©rcio Atacadista de Equipamentos de Inform√°tica"
      },
      {
        "cnaeCodigoSecundario": 4652400,
        "cnaeDescricaoSecundario": "Com√©rcio Atacadista de Componentes Eletr√¥nicos E Equipamentos de Telefonia E Comunica√ß√£o"
      },
      {
        "cnaeCodigoSecundario": 4742300,
        "cnaeDescricaoSecundario": "Com√©rcio Varejista de Material El√©trico"
      },
      {
        "cnaeCodigoSecundario": 5232000,
        "cnaeDescricaoSecundario": "Atividades de Agenciamento Mar√≠timo"
      },
      {
        "cnaeCodigoSecundario": 5250803,
        "cnaeDescricaoSecundario": "Agenciamento de Cargas, Exceto para O Transporte Mar√≠timo"
      },
      {
        "cnaeCodigoSecundario": 5250804,
        "cnaeDescricaoSecundario": "Organiza√ß√£o Log√≠stica do Transporte de Carga"
      },
      {
        "cnaeCodigoSecundario": 5911102,
        "cnaeDescricaoSecundario": "Produ√ß√£o de Filmes para Publicidade"
      },
      {
        "cnaeCodigoSecundario": 6201501,
        "cnaeDescricaoSecundario": "Desenvolvimento de Programas de Computador sob Encomenda"
      },
      {
        "cnaeCodigoSecundario": 7319003,
        "cnaeDescricaoSecundario": "Marketing Direto"
      },
      {
        "cnaeCodigoSecundario": 7319004,
        "cnaeDescricaoSecundario": "Consultoria em Publicidade"
      },
      {
        "cnaeCodigoSecundario": 7729202,
        "cnaeDescricaoSecundario": "Aluguel de M√≥veis, Utens√≠lios E Aparelhos de Uso Dom√©stico E Pessoal, Instrumentos Musicais"
      },
      {
        "cnaeCodigoSecundario": 7739099,
        "cnaeDescricaoSecundario": "Aluguel de Outras M√°quinas E Equipamentos Comerciais E Industriais N√£o Especificados Anteriormente, sem Operador"
      },
      {
        "cnaeCodigoSecundario": 8211300,
        "cnaeDescricaoSecundario": "Servi√ßos Combinados de Escrit√≥rio E Apoio Administrativo"
      }
    ],
    "situacaoCadastral": "Ativa",
    "situacaoEspecial": null,
    "naturezaJuridicaCodigo": 2062,
    "naturezaJuridicaDescricao": "Sociedade Empres√°ria Limitada",
    "naturezaJuridicaTipo": null,
    "porte": null,
    "faixaFuncionarios": "At√© 9 Funcion√°rios",
    "quantidadeFuncionarios": 6,
    "faixaFaturamento": "R$ 2.800.000 at√© R$ 4.800.000",
    "faturamentoMedioCNAE": "R$ 7.709.681,74",
    "faturamentoPresumido": "R$ 3.573.054,55",
    "matriz": true,
    "orgaoPublico": null,
    "ramo": null,
    "tipoEmpresa": "LTDA",
    "tributacao": "LUCRO PRESUMIDO",
    "opcaoMEI": "N√ÉO",
    "opcaoSimples": "N√ÉO",
    "quantidadeFiliais": "1 at√© 2 filiais",
    "telefones": [
      {
        "telefoneComDDD": "(11) 3086-3312",
        "telemarketingBloqueado": false,
        "operadora": "VIVO",
        "tipoTelefone": "TELEFONE RESIDENCIAL",
        "whatsApp": false
      },
      {
        "telefoneComDDD": "(11) 3135-6548",
        "telemarketingBloqueado": false,
        "operadora": null,
        "tipoTelefone": "TELEFONE RESIDENCIAL",
        "whatsApp": false
      },
      {
        "telefoneComDDD": "(11) 3596-3746",
        "telemarketingBloqueado": false,
        "operadora": "CLARO",
        "tipoTelefone": "TELEFONE RESIDENCIAL",
        "whatsApp": false
      },
      {
        "telefoneComDDD": "(11) 5140-1339",
        "telemarketingBloqueado": false,
        "operadora": null,
        "tipoTelefone": "TELEFONE RESIDENCIAL",
        "whatsApp": false
      },
      {
        "telefoneComDDD": "(11) 98955-2343",
        "telemarketingBloqueado": false,
        "operadora": "CLARO",
        "tipoTelefone": "TELEFONE M√ìVEL",
        "whatsApp": true
      }
    ],
    "enderecos": [
      {
        "logradouro": "AV PAULISTA",
        "numero": "302",
        "complemento": "AND 10 CJ 10",
        "bairro": "BELA VISTA",
        "cidade": "SAO PAULO",
        "uf": "SP",
        "cep": "01310-000"
      },
      {
        "logradouro": "R ESTADOS UNIDOS",
        "numero": "2186",
        "complemento": null,
        "bairro": "JARDIM AMERICA",
        "cidade": "SAO PAULO",
        "uf": "SP",
        "cep": "01427-002"
      }
    ],
    "emails": [
      {
        "enderecoEmail": "contato@insightcontabilidade.com"
      },
      {
        "enderecoEmail": "savio@insightcontabilidade.com"
      }
    ],
    "ultimaAtualizacaoPJ": "24/06/2025 00:00:00",
    "socios": [
      {
        "documento": "314.628.368-95",
        "nome": "Daniel Horn",
        "percentualParticipacao": "50.00",
        "dataEntrada": "21/09/2020 00:00:00",
        "cargo": "S√≥cio Administrador"
      },
      {
        "documento": "346.422.928-96",
        "nome": "Rafael Bamenga",
        "percentualParticipacao": "50.00",
        "dataEntrada": "31/10/2019 00:00:00",
        "cargo": "S√≥cio Administrador"
      }
    ]
  }
}
üéØ SCORE REAL DA API QUOD: 458
üìä FAIXA SCORE: Alto √≠ndice de inadimpl√™ncia
üí° MOTIVOS DO SCORE: []
üìä DADOS PRINCIPAIS DO CADASTRO:
  - capitalSocial: undefined
  - faturamentoPresumido: R$ 3.573.054,55
  - dataInicioAtividade: undefined
  - dataFundacao: 31/10/2019 00:00:00
  - dataAbertura: undefined
  - socios: [
  {
    "documento": "314.628.368-95",
    "nome": "Daniel Horn",
    "percentualParticipacao": "50.00",
    "dataEntrada": "21/09/2020 00:00:00",
    "cargo": "S√≥cio Administrador"
  },
  {
    "documento": "346.422.928-96",
    "nome": "Rafael Bamenga",
    "percentualParticipacao": "50.00",
    "dataEntrada": "31/10/2019 00:00:00",
    "cargo": "S√≥cio Administrador"
  }
]
Error fetching credit score: TypeError: value.toISOString is not a function
    at PgTimestamp.mapToDriverValue (/home/runner/workspace/node_modules/src/pg-core/columns/timestamp.ts:66:16)
    at <anonymous> (/home/runner/workspace/node_modules/src/sql/sql.ts:223:69)
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/runner/workspace/node_modules/src/sql/sql.ts:148:30)
    at <anonymous> (/home/runner/workspace/node_modules/src/sql/sql.ts:170:17)
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/runner/workspace/node_modules/src/sql/sql.ts:148:30)
    at <anonymous> (/home/runner/workspace/node_modules/src/sql/sql.ts:174:17)
    at Array.map (<anonymous>)
    at SQL.buildQueryFromSourceParams (/home/runner/workspace/node_modules/src/sql/sql.ts:148:30)
    at <anonymous> (/home/runner/workspace/node_modules/src/sql/sql.ts:124:23)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at SQL.toQuery (/home/runner/workspace/node_modules/src/sql/sql.ts:123:17)
    at PgDialect.sqlToQuery (/home/runner/workspace/node_modules/src/pg-core/dialect.ts:591:14)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/insert.ts:405:19)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at QueryPromise._prepare (/home/runner/workspace/node_modules/src/pg-core/query-builders/insert.ts:400:17)
    at <anonymous> (/home/runner/workspace/node_modules/src/pg-core/query-builders/insert.ts:422:16)
    at Object.startActiveSpan (/home/runner/workspace/node_modules/src/tracing.ts:27:11)
    at QueryPromise.execute (/home/runner/workspace/node_modules/src/pg-core/query-builders/insert.ts:421:17)
    at QueryPromise.then (/home/runner/workspace/node_modules/src/query-promise.ts:31:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
11:03:42 PM [express] POST /api/credit/applications/63/credit-score 500 in 2636ms :: {"message":"Erro‚Ä¶
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:44 PM [express] GET /api/notifications/unread-count 200 in 122ms
[Session Debug] GET /api/notifications - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:59 PM [express] GET /api/notifications 200 in 475ms
[Session Debug] GET /api/notifications/unread-count - Session ID: d3ef_VsOaAb0qzv5IBLcJGe8E2fFmTk9, User ID: 22
11:03:59 PM [express] GET /api/notifications/unread-count 200 in 473ms