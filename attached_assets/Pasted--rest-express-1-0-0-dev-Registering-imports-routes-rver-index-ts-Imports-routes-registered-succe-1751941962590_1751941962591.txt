
> rest-express@1.0.0 dev
Registering imports routes...rver/index.ts
Imports routes registered successfully
2:30:23 AM [express] serving on port 5000
Browserslist: browsers data (caniuse-lite) is 9 months old. Please run:
  npx update-browserslist-db@latest
  Why you should do it regularly: https://github.com/browserslist/update-db#readme
[Session Debug] GET /api/auth/user - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: undefined
2:30:34 AM [express] GET /api/auth/user 200 in 120ms :: {"user":null,"authenticated":false}
[Session Debug] GET /api/auth/user - Session ID: sN6zbhKwLKpYPC0dh3pybRPxwgYo-_kC, User ID: undefined
2:30:40 AM [express] GET /api/auth/user 200 in 116ms :: {"user":null,"authenticated":false}
[Session Debug] POST /api/auth/login - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: undefined
Login attempt for: admin@sparkcomex.com
Searching for user with email: admin@sparkcomex.com
User found - ID: 2 Email: admin@sparkcomex.com Status: active
Password hash exists: true
Password comparison result: true
Session created for user ID: 2 Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT
Session saved successfully for user: admin@sparkcomex.com
2:31:06 AM [express] POST /api/auth/login 200 in 832ms :: {"id":2,"companyName":"Spark Comex Admin",‚Ä¶
[Session Debug] GET /api/auth/user - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:07 AM [express] GET /api/auth/user 200 in 177ms :: {"user":{"id":2,"companyName":"Spark Comex A‚Ä¶
[Session Debug] GET /api/notifications - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:07 AM [express] GET /api/notifications 200 in 124ms
[Session Debug] GET /api/notifications/unread-count - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
[Session Debug] GET /api/admin/dashboard/metrics - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
Auth check - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT User ID: 2
2:31:07 AM [express] GET /api/notifications/unread-count 200 in 484ms
Authentication successful for user: 2 Role: admin
Fetching fresh admin metrics
2:31:09 AM [express] GET /api/admin/dashboard/metrics 200 in 2559ms :: {"totalImporters":7,"totalApp‚Ä¶
[Session Debug] GET /api/imports - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
Auth check - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT User ID: 2
Authentication successful for user: 2 Role: admin
üîç IMPORTS REQUEST - User 2, Role: admin
üîó Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT
üëë Admin/Financeira fetched 0 total imports
‚úÖ Sending 0 imports to frontend
2:31:14 AM [express] GET /api/imports 200 in 306ms :: []
[Session Debug] GET /api/suppliers - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
Auth check - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT User ID: 2
Authentication successful for user: 2 Role: admin
2:31:14 AM [express] GET /api/suppliers 200 in 236ms :: []
[Session Debug] GET /api/notifications/unread-count - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:22 AM [express] GET /api/notifications/unread-count 200 in 121ms
[Session Debug] GET /api/notifications - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:37 AM [express] GET /api/notifications 200 in 484ms
[Session Debug] GET /api/notifications/unread-count - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:38 AM [express] GET /api/notifications/unread-count 200 in 130ms
[Session Debug] GET /api/notifications/unread-count - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:31:53 AM [express] GET /api/notifications/unread-count 200 in 475ms
[Session Debug] GET /api/auth/user - Session ID: fiLxP-CY7k_Ss6PhKPADy9Kb16g_S5vT, User ID: 2
2:32:01 AM [express] GET /api/auth/user 200 in 314ms :: {"user":null,"authenticated":false}
[Session Debug] POST /api/auth/login - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: undefined
Login attempt for: admin@sparkcomex.com
Searching for user with email: admin@sparkcomex.com
User found - ID: 21 Email: admin@sparkcomex.com Status: active
Password hash exists: true
Password comparison result: true
Session created for user ID: 21 Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO
Session saved successfully for user: admin@sparkcomex.com
2:32:04 AM [express] POST /api/auth/login 200 in 295ms :: {"id":21,"companyName":"Spark Comex Admin"‚Ä¶
[Session Debug] GET /api/auth/user - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
2:32:04 AM [express] GET /api/auth/user 200 in 186ms :: {"user":{"id":21,"companyName":"Spark Comex ‚Ä¶
[Session Debug] GET /api/notifications - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
[Session Debug] GET /api/notifications/unread-count - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
[Session Debug] GET /api/imports - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
2:32:04 AM [express] GET /api/notifications 200 in 121ms
2:32:04 AM [express] GET /api/notifications/unread-count 200 in 121ms
Authentication successful for user: 21 Role: admin
üîç IMPORTS REQUEST - User 21, Role: admin
üîó Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO
üëë Admin/Financeira fetched 0 total imports
‚úÖ Sending 0 imports to frontend
2:32:05 AM [express] GET /api/imports 304 in 310ms :: []
[Session Debug] GET /api/suppliers - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
Authentication successful for user: 21 Role: admin
2:32:05 AM [express] GET /api/suppliers 304 in 237ms :: []
[Session Debug] GET /api/admin/credit-applications - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
Authentication successful for user: 21 Role: admin
Admin credit applications request - User: 21
Current user role: admin
Fetching fresh credit applications
Found 4 credit applications
2:32:07 AM [express] GET /api/admin/credit-applications 304 in 297ms :: [{"id":73,"userId":40,"legal‚Ä¶
[Session Debug] GET /api/admin/credit-applications/61 - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
Authentication successful for user: 21 Role: admin
üîç PROTE√á√ÉO: admin tentando acessar /api/admin/credit-applications/61
[Session Debug] GET /api/user/financial-settings - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
[Session Debug] GET /api/user/financial-settings - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
üîç Fetching financial settings for user: 21
üë§ User data: {
  id: 21,
  defaultAdminFeeRate: null,
  defaultDownPaymentRate: null,
  defaultPaymentTerms: null
}
üí∞ Final settings being sent: {
  adminFeePercentage: 10,
  downPaymentPercentage: 30,
  paymentTerms: '30,60,90'
}
2:32:13 AM [express] GET /api/user/financial-settings 304 in 394ms :: {"adminFeePercentage":10,"down‚Ä¶
2:32:13 AM [express] GET /api/admin/credit-applications/61 304 in 1117ms :: {"id":61,"userId":32,"le‚Ä¶
[Session Debug] GET /api/credit/applications/61/credit-score - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
Authentication successful for user: 21 Role: admin
2:32:14 AM [express] GET /api/credit/applications/61/credit-score 404 in 731ms :: {"message":"Credit‚Ä¶
[Session Debug] POST /api/credit/applications/61/credit-score - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
Auth check - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO User ID: 21
Authentication successful for user: 21 Role: admin
üìä Calling Receita WS API for CNPJ: 65484271000105
‚úÖ Receita WS API response received
üè¶ Calling DirectD QUOD Score API for CNPJ: 65484271000105
DirectD Score API Response Status: 200
‚úÖ DirectD Score API response received
Raw API response: {
  "metaDados": {
    "consultaNome": "Score de Cr√©dito - QUOD",
    "consultaUid": "direct-c303294c-8a1d-4ba8-991a-924a65bcbb8b",
    "chave": "CNPJ=65484271000105;",
    "usuario": "Marcio Pavao",
    "mensagem": "Sucesso",
    "ip": "34.127.117.128",
    "resultadoId": 1,
    "resultado": "Sucesso",
    "apiVersao": "v3",
    "gerarComprovante": false,
    "urlComprovante": null,
    "assincrono": false,
    "data": "07/07/2025 23:32:18",
    "tempoExecucaoMs": 661
  },
  "retorno": {
    "dataConsulta": "07/07/2025 23:29:02",
    "documentoConsultado": "65.484.271/0001-05",
    "pessoaFisica": null,
    "pessoaJuridica": {
      "score": 368,
      "faixaScore": "Alto √≠ndice de inadimpl√™ncia",
      "motivos": [
        "Possui pouco volume de pagamentos em dia",
        "Possui atrasos de parcelas/faturas em contratos recentes",
        "Possui pouco volume de pagamentos em dia",
        "Possui contratos com alto valor para quita√ß√£o"
      ],
      "indicadoresNegocio": [
        {
          "indicador": "Pontualidade de Pagamento",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Gravidade (tempo) em Atrasos",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Uso Emergencial",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Endividamento Contrato e Credores",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Risco do Perfil de Contrata√ß√£o",
          "status": null,
          "risco": null,
          "observacao": null
        },
        {
          "indicador": "Busca por Cr√©dito Mensal (Quantidade de Novas Contrata√ß√µes)",
          "status": null,
          "risco": null,
          "observacao": null
        }
      ]
    },
    "observacao": null
  }
}
‚ö†Ô∏è DirectD Score API returned error: Sucesso
‚úÖ DirectD Score API data received successfully
üè¢ Calling DirectD Cadastro API for CNPJ: 65484271000105
[Session Debug] GET /api/notifications/unread-count - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
2:32:19 AM [express] GET /api/notifications/unread-count 200 in 128ms
‚úÖ DirectD Cadastro API response received
‚úÖ DirectD Cadastro API data received successfully
No DirectD Score API data - using Receita WS or Cadastro API only
No valid DirectD Score API data available
üîç Primary data keys: [
  'cnpj',
  'razaoSocial',
  'nomeFantasia',
  'dataFundacao',
  'cnaeCodigo',
  'cnaeDescricao',
  'cnaEsSecundarios',
  'situacaoCadastral',
  'situacaoEspecial',
  'naturezaJuridicaCodigo',
  'naturezaJuridicaDescricao',
  'naturezaJuridicaTipo',
  'porte',
  'faixaFuncionarios',
  'quantidadeFuncionarios',
  'faixaFaturamento',
  'faturamentoMedioCNAE',
  'faturamentoPresumido',
  'matriz',
  'orgaoPublico',
  'ramo',
  'tipoEmpresa',
  'tributacao',
  'opcaoMEI',
  'opcaoSimples',
  'quantidadeFiliais',
  'telefones',
  'enderecos',
  'emails',
  'ultimaAtualizacaoPJ',
  'socios'
]
üîç Date fields: {
  dataFundacao: '08/02/1991 00:00:00',
  abertura: undefined,
  dataAbertura: undefined
}
Error fetching credit score: error: null value in column "credit_score" of relation "credit_scores" violates not-null constraint
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async DatabaseStorage.createCreditScore (/home/runner/workspace/server/storage.ts:1734:21)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:3583:26) {
  length: 1033,
  severity: 'ERROR',
  code: '23502',
  detail: 'Failing row contains (16, 61, 65.484.271/0001-05, null, 2025-07-08 02:32:20.323, {"cnpj": "65.484.271/0001-05", "ramo": null, "porte": "Micro", "..., PROW IMPORTADORA E DISTRIBUIDORA DE PRODUTOS PARA SAUDE LTDA, PROW MEDICAMENTOS, Ativa, 1991-02-08 00:00:00, N√£o informado, COMTIPO R JOAO RAMALHO, 59, CENTRO, SAO BERNARDO DO CAMPO, SP, 09715-360, (11) 91173-3178, financeiro@prowmedicamentos.com.br, {"code": "4644301", "description": "Com√©rcio Atacadista de Medi..., [{"code": "4618401", "description": "Representantes Comerciais E..., [{"name": "Rosana Aparecida Fabiano", "document": "225.036.868-6..., null, null, null, null, null, 2025-07-08 02:32:20.358542, 2025-07-08 02:32:20.358542, 2025-07-08 02:32:20.323, {}, null, null, null, {}, {}, PENDING_ANALYSIS, {}, {}, {}, {}, success, pending, 2025-07-08 02:32:20.323, null, null).',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'credit_scores',
  column: 'credit_score',
  dataType: undefined,
  constraint: undefined,
  file: 'execMain.c',
  line: '2006',
  routine: 'ExecConstraints'
}
2:32:20 AM [express] POST /api/credit/applications/61/credit-score 500 in 3327ms :: {"message":"Erro‚Ä¶
[Session Debug] GET /api/notifications - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
2:32:35 AM [express] GET /api/notifications 200 in 500ms
[Session Debug] GET /api/notifications/unread-count - Session ID: 21FPfSOodNZzOpo8vbLMnvdRoROwd0zO, User ID: 21
2:32:35 AM [express] GET /api/notifications/unread-count 200 in 477ms
